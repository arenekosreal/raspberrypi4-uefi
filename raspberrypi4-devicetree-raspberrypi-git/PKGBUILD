# Maintainer: zhanghua <zhanghua.00@qq.com>

buildarch=8 # aarch64

KBRANCH=${KBRANCH:-5.19}
# Only need if you are using raspberrypi kernel
USE_LLVM=${USE_LLVM:-false}
# Weather using LLVM or GCC
_count_start=3d7cb6b # Linux 5.19

pkgbase="raspberrypi4-devicetree-raspberrypi-git"
pkgname=("raspberrypi4-overlays-raspberrypi-git" "raspberrypi4-dtbs-raspberrypi-git")
pkgver=5.19.r700.1d21e5ecd957
pkgrel=2
url="https://github.com/raspberrypi/linux"
arch=("any")
license=("GPL")
groups=("raspberrypi4-uefi")
options=("!strip")
makedepends=("git")
conflicts=("raspberrypi-devicetree")
source=(
    user_ns_unprivileged.patch
    config-raspberrypi
    linux-raspberrypi::git+https://github.com/raspberrypi/linux.git#branch=rpi-${KBRANCH}.y)
sha256sums=('44f31b8ae7bc7d4547710c9906a8dfec06f3a0b2bff17939bf426200d6575f41'
            '751ffd8ef2dcff64d5dd57f461c186e55282ddbef5d205ec4dcfb1385d453de6'
            'SKIP')
if [ $(uname -m) != "aarch64" ]
then
    options+=(!ccache)
    export ARCH=arm64
    export CROSS_COMPILE=aarch64-linux-gnu-
fi
if [[ ${USE_LLVM} == true ]]
then
    # LLVM
    makedepends+=("clang" "lld" "llvm")
    export LLVM=1
    export _STRIPBIN=/usr/bin/llvm-strip
elif [ $(uname -m) != "aarch64" ]
then
    # GCC Cross-compile
    makedepends+=("aarch64-linux-gnu-gcc")
    export _STRIPBIN=/usr/bin/${CROSS_COMPILE}strip
else
    # native compile
    export _STRIPBIN=/usr/bin/strip
fi

export LOCALVERSION=""
# Disable annoying '+' in modules folder and kernel name

pkgver(){
    cd ${srcdir}/linux-raspberrypi
    version_str=$(make -s kernelversion | sed 's/.0//;s/-/./')
    release_num=r$(git rev-list --count ${_count_start}..HEAD)
    commit_id=$(git rev-parse --short HEAD)
    echo ${version_str}.${release_num}.${commit_id}
}
prepare(){
    cd ${srcdir}/linux-raspberrypi
    cp ${srcdir}/config-raspberrypi .config
    git apply ${srcdir}/user_ns_unprivileged.patch
    make olddefconfig
    sed -i "s/CONFIG_LOCALVERSION_AUTO=y/# CONFIG_LOCALVERSION_AUTO is not set/;s/CONFIG_SURFACE_PLATFORMS=y/# CONFIG_SURFACE_PLATFORMS is not set/" .config
    echo "-$pkgrel" > localversion.10-pkgrel
    echo "" > localversion.20-pkgname
    make -s kernelrelease > version
    scripts/setlocalversion --save-scmversion
    make prepare
}
build(){
    cd ${srcdir}/linux-raspberrypi
    make dtbs
}
package_raspberrypi4-overlays-raspberrypi-git(){
    pkgdesc="/boot/overlays folder for Raspberry Pi 4B"
    conflicts+=("raspberrypi4-overlays")
    provides=("raspberrypi4-overlays")
    cd ${srcdir}/linux-raspberrypi
    mkdir -p ${pkgdir}/boot/overlays
    cp ${srcdir}/linux-raspberrypi/arch/arm64/boot/dts/overlays/{README,*.dtb*} ${pkgdir}/boot/overlays
}
package_raspberrypi4-dtbs-raspberrypi-git(){
    pkgdesc="/boot/bcm2711-rpi-4-b.dtb for Raspberry Pi 4B"
    conflicts+=("raspberrypi4-dtbs")
    provides=("raspberrypi4-dtbs")
    install -Dm644 ${srcdir}/linux-raspberrypi/arch/arm64/boot/dts/broadcom/bcm2711-rpi-4-b.dtb \
        ${pkgdir}/boot/bcm2711-rpi-4-b.dtb
}
